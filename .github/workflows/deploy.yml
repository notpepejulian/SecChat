name: Project Workflow (Dev, Pre, Main)

on:
  push:
    branches:
      - dev
      - pre
      - main

jobs:
  # 1. Rama dev: Secret Scanning
  dev-validation:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    environment: Dev 
    steps:
      - name: Checkout Código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Secret Scanning (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 2. Rama pre: Validación de Build e Infra
  pre-build-validate:
    if: github.ref == 'refs/heads/pre'
    runs-on: ubuntu-latest
    environment: Pre
    steps:
      - name: Checkout Código
        uses: actions/checkout@v4
      - name: Validar Docker Compose Build
        run: docker compose -f docker-compose.prod.yml build
      - name: Escaneo de configuración (Dockerfiles y Compose)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  pre-infra-scan:
    if: github.ref == 'refs/heads/pre'
    needs: pre-build-validate
    runs-on: ubuntu-latest
    environment: Pre
    strategy:
      fail-fast: false
      matrix:
        imagen: [
          'mariadb:lts', 
          'redis:alpine', 
          'matrixdotorg/synapse:develop', 
          'nginx:alpine', 
          'tailscale/tailscale:latest'
        ]
    steps:
      - name: Escaneo de vulnerabilidades - ${{ matrix.imagen }}
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.imagen }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'

  # 3. Rama main: Producción y Release
  production-release:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: Prod  
    permissions:
      contents: write
      security-events: write 
    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      - name: Initialize CodeQL (Python)
        uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

      - name: Crear Release de GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          body: |
            Release automático v1.0.${{ github.run_number }}
            - Análisis estático CodeQL completado.
            - Infraestructura externa validada.
          files: |
            chatsender-v1.0.${{ github.run_number }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}